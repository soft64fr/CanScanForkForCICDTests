name: Build and Release Native Windows App

on:
  push:
    branches:
      - main

jobs:
  # ------------------------------------------------------------------------
  # 1. JOB WINDOWS
  # ------------------------------------------------------------------------
#  package_for_windows:
#    name: Package for Windows
#    runs-on: windows-latest
#    env:
#      LIBERICA_VERSION: 23.1.9
#      OPENJDK_VERSION: 21.0.9+12
#      LIBERICA_FOLDER: LibericaNIK-23-OpenJDK-21
#      LIBERICA_MSI: bellsoft-liberica-vm-openjdk21.0.9+12-23.1.9+1-windows-amd64.msi
#      MSVC_VCVARS: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat
#      INNOSETUP_EXE: C:\Program Files (x86)\Inno Setup 6\ISCC.exe
#
#    steps:
#      - name: Harden Runner
#        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
#        with:
#          egress-policy: audit
#
#      - name: Checkout code
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - name: Extract locale properties from pom.xml
#        shell: bash
#        run: |
#          lang=$(mvn help:evaluate -Dexpression=app.lang -q -DforceStdout)
#          country=$(mvn help:evaluate -Dexpression=app.country -q -DforceStdout)
#          echo "APP_LANG=$lang" >> $GITHUB_ENV
#          echo "APP_COUNTRY=$country" >> $GITHUB_ENV
#
#      - name: Set JAVA_TOOL_OPTIONS from pom.xml
#        shell: pwsh
#        run: |
#          echo "JAVA_TOOL_OPTIONS=-Duser.language=$env:APP_LANG -Duser.country=$env:APP_COUNTRY -Duser.region=$env:APP_COUNTRY" >> $env:GITHUB_ENV
#
#      - name: Cache Maven dependencies
#        uses: actions/cache@v3
#        with:
#          path: ~\.m2\repository
#          key: maven-repo-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
#          restore-keys: |
#            maven-repo-${{ runner.os }}-
#
#      - name: Cache Liberica NIK installer
#        uses: actions/cache@v3
#        with:
#          path: liberica-nik.msi
#          key: liberica-nik-${{ runner.os }}-${{ env.LIBERICA_VERSION }}
#
#      - name: Download and install Liberica NIK via MSI
#        shell: cmd
#        run: |
#          if not exist liberica-nik.msi (
#            curl -L -o liberica-nik.msi https://download.bell-sw.com/vm/${{ env.LIBERICA_VERSION }}/${{ env.LIBERICA_MSI }}
#          )
#          msiexec /quiet /i liberica-nik.msi
#
#      - name: List BellSoft installation folders
#        shell: cmd
#        run: dir "C:\Program Files\BellSoft"
#
#      - name: Set JAVA_HOME and update PATH
#        shell: pwsh
#        run: |
#          $env:JAVA_HOME = "C:\Program Files\BellSoft\${{ env.LIBERICA_FOLDER }}"
#          echo "JAVA_HOME=$env:JAVA_HOME" >> $env:GITHUB_ENV
#          echo "NIK_HOME=$env:JAVA_HOME" >> $env:GITHUB_ENV
#          echo "$env:JAVA_HOME\bin" >> $env:GITHUB_PATH
#          echo "$env:JAVA_HOME\lib" >> $env:GITHUB_PATH
#
#      - name: Initialize MSVC environment
#        shell: cmd
#        run: |
#          call "${{ env.MSVC_VCVARS }}"
#          cl.exe || (echo ‚ùå MSVC compiler not found & exit /b 1)
#
#      - name: Extract version from pom.xml
#        shell: pwsh
#        run: |
#          $pom = Get-Content "pom.xml" -Raw
#          if ($pom -match '<parent>[\s\S]*?</parent>[\s\S]*?<version>(.+?)</version>') {
#            $version = $matches[1]
#          } elseif ($pom -match '<version>(.+?)</version>') {
#            $version = $matches[1]
#          } else {
#            Write-Host "‚ùå Impossible d'extraire la version depuis pom.xml"
#            exit 1
#          }
#          echo "POM_VERSION=$version" >> $env:GITHUB_ENV
#          Write-Host "Version extraite: $version"
#
#      - name: Cache Inno Setup installer
#        uses: actions/cache@v3
#        with:
#          path: ${{ runner.temp }}\is.exe
#          key: inno-setup-${{ runner.os }}
#
#      - name: Install Inno Setup
#        shell: cmd
#        run: |
#          if not exist "%TEMP%\is.exe" (
#            powershell -Command "Invoke-WebRequest 'https://jrsoftware.org/download.php/is.exe' -OutFile '%TEMP%\is.exe'"
#          )
#          "%TEMP%\is.exe" /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-
#
#      - name: Set INNOSETUP path
#        shell: pwsh
#        run: |
#          if (-not (Test-Path "${{ env.INNOSETUP_EXE }}")) {
#            Write-Host "‚ùå Inno Setup not found at expected path"
#            exit 1
#          }
#          echo "INNOSETUP=${{ env.INNOSETUP_EXE }}" >> $env:GITHUB_ENV
#
#      - name: Show environment variables
#        shell: pwsh
#        run: |
#          Write-Host "JAVA_HOME=$env:JAVA_HOME"
#          Write-Host "NIK_HOME=$env:NIK_HOME"
#          Write-Host "PATH=$env:PATH"
#          Write-Host "INNOSETUP=$env:INNOSETUP"
#          Write-Host "POM_VERSION=$env:POM_VERSION"
#
#      - name: Compile, Test, and analyze with Maven profile
#        shell: cmd
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
#        run: |
#          mvn -B test -f pom.xml ^
#
#      - name: Build native Windows package
#        shell: cmd
#        run: mvn package -Pwindows-native
#
#      - name: List files in output directory
#        shell: pwsh
#        run: |
#          if (Test-Path output) {
#            Get-ChildItem -Path output
#          }
#
#      - name: Generate hash file for Windows
#        shell: pwsh
#        run: |
#          $exeFile = Get-ChildItem -Path output -Filter "*.exe" | Select-Object -First 1
#          if ($exeFile) {
#            $hash = (Get-FileHash $exeFile.FullName -Algorithm SHA256).Hash
#            "$hash  $($exeFile.Name)" | Out-File -FilePath "output\hash_windows.txt" -Encoding UTF8
#          }
#
#      - name: Upload output folder (Windows)
#        uses: actions/upload-artifact@v4
#        with:
#          name: output-folder-windows
#          path: output

# ------------------------------------------------------------------------
# 2. JOB UBUNTU/AppImage (NIK t√©l√©charg√© manuellement)
# ------------------------------------------------------------------------
  package_for_ubuntu:
    name: Package for Ubuntu (AppImage)
    runs-on: ubuntu-latest
    env:
      LIBERICA_VERSION: 23.1.9
      OPENJDK_VERSION: 21.0.9+12
      LIBERICA_TGZ: bellsoft-liberica-vm-openjdk21.0.9+12-23.1.9+1-linux-amd64.tar.gz
      NIK_INSTALL_DIR: $HOME/liberica-nik

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install native dependencies
        run: |
          sudo apt update          
          sudo apt install build-essential libz-dev zlib1g-dev libxext-dev libxi-dev libxrender-dev libxtst-dev libfontconfig1 -y
          sudo DEBIAN_FRONTEND=noninteractive apt install xdg-utils software-properties-common -y          
          sudo snap remove firefox 2>/dev/null || true
          sudo add-apt-repository ppa:mozillateam/ppa -y          
          # Correction du pinning APT: Utilisation de 'cat <<-' et alignement du contenu √† gauche
          cat <<- 'EOF' | sudo tee /etc/apt/preferences.d/mozilla-firefox
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          EOF
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install firefox-esr -y
          sudo ln -sf /usr/bin/firefox-esr /usr/bin/firefox
          firefox-esr --version
          which firefox-esr

      - name: Verify browser setup
        run: |
          xdg-settings set default-web-browser firefox-esr.desktop || \
          xdg-settings set default-web-browser firefox.desktop
          echo "Default browser: $(xdg-settings get default-web-browser)"
          timeout 5s xdg-open "https://example.com" &
          sleep 2

      - name: Cache Liberica NIK tarball
        uses: actions/cache@v3
        with:
          path: liberica-nik.tar.gz
          key: liberica-nik-${{ runner.os }}-${{ env.LIBERICA_VERSION }}

      - name: Download and Extract Liberica NIK (Linux)
        shell: bash
        run: |
          NIK_FILE="liberica-nik.tar.gz"
          DOWNLOAD_URL="https://download.bell-sw.com/vm/${{ env.LIBERICA_VERSION }}/${{ env.LIBERICA_TGZ }}"
          if [ ! -f "$NIK_FILE" ]; then
            curl -L -o "$NIK_FILE" "$DOWNLOAD_URL"
          fi
          mkdir -p ${{ env.NIK_INSTALL_DIR }}
          tar -xzf "$NIK_FILE" -C ${{ env.NIK_INSTALL_DIR }} --strip-components=1

      - name: Set JAVA_HOME and update PATH
        shell: bash
        run: |
          echo "JAVA_HOME=${{ env.NIK_INSTALL_DIR }}" >> $GITHUB_ENV
          echo "NIK_HOME=${{ env.NIK_INSTALL_DIR }}" >> $GITHUB_ENV
          echo "${{ env.NIK_INSTALL_DIR }}/bin" >> $GITHUB_PATH

      - name: Check Java environment (NIK confirmed)
        run: |
          java -version
          native-image --version

      - name: Extract app properties from pom.xml
        id: properties
        run: |
          APP_NAME=$(mvn help:evaluate -Dexpression=app.name -q -DforceStdout)
          APP_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          ORG_NAME=$(mvn help:evaluate -Dexpression=app.org -q -DforceStdout)
          MAIN_CLASS=$(mvn help:evaluate -Dexpression=app.mainclass -q -DforceStdout)
          LANG_CODE=$(mvn help:evaluate -Dexpression=app.lang -q -DforceStdout)
          COUNTRY_CODE=$(mvn help:evaluate -Dexpression=app.country -q -DforceStdout)
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "POM_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "ORG_NAME=$ORG_NAME" >> $GITHUB_ENV
          echo "MAIN_CLASS=$MAIN_CLASS" >> $GITHUB_ENV
          echo "LANG_CODE=$LANG_CODE" >> $GITHUB_ENV
          echo "COUNTRY_CODE=$COUNTRY_CODE" >> $GITHUB_ENV

      - name: Install Xvfb
        run: sudo apt-get install -y xvfb

      - name: Start Xvfb and set DISPLAY
        run: |
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Build native Linux package
        shell: bash
        run: mvn package -Plinux-native

      - name: Generate hash file for AppImage
        shell: bash
        run: |
          APPIMAGE_FILE=$(find output -name "*.AppImage" | head -n 1)
          if [ -f "$APPIMAGE_FILE" ]; then
            hash=$(sha256sum "$APPIMAGE_FILE" | awk '{print $1}')
            filename=$(basename "$APPIMAGE_FILE")
            echo "$hash  $filename" > output/hash_ubuntu.txt
          else
            exit 1
          fi

      - name: Upload output folder (AppImage)
        uses: actions/upload-artifact@v4
        with:
          name: output-folder-ubuntu
          path: output

  # ------------------------------------------------------------------------
  # 3. JOB PUBLISH (Adapt√© pour d√©pendre des deux jobs pr√©c√©dents et t√©l√©charger les deux artifacts)
  # ------------------------------------------------------------------------
  publish_release:
    permissions:
      contents: write
    name: Publish the release and tag it
#    needs: [package_for_windows, package_for_ubuntu]
    needs: [ package_for_ubuntu ]
    runs-on: ubuntu-latest
    env:
      GPG_PUBLIC_KEY: ${{ secrets.GPG_PUBLIC_KEY }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from pom.xml
        shell: bash
        run: |
          version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "POM_VERSION=$version" >> $GITHUB_ENV

      - name: Download all output folders
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: Merge output folders
        run: |
          mkdir -p output
          # Copie des fichiers de Windows (ils sont dans le sous-dossier output-folder-windows)
          cp output-folder-windows/* output/
          # Copie des fichiers d'Ubuntu (ils sont dans le sous-dossier output-folder-ubuntu)
          cp output-folder-ubuntu/* output/

      - name: List files in final output directory
        run: ls -la output/

      - name: GPG - Import private key using an isolated configuration
        if: env.GPG_PUBLIC_KEY != ''
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "::add-mask::$GPG_PRIVATE_KEY"
          export GNUPGHOME=$(mktemp -d)
          chmod 700 $GNUPGHOME
          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import
          echo "allow-loopback-pinentry" > $GNUPGHOME/gpg-agent.conf
          gpgconf --homedir $GNUPGHOME --reload gpg-agent
          echo "GNUPGHOME=$GNUPGHOME" >> $GITHUB_ENV

      - name: GPG - Sign and verify files (excluding .txt and .asc)
        if: env.GPG_PUBLIC_KEY != ''
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "::add-mask::$GPG_PASSPHRASE"
          export GPG_TTY=$(tty)

          # List files in output directory
          echo "Files in output directory:"
          ls -la output/

          for file in output/*; do
            if [[ -f "$file" && ! "$file" == *.txt && ! "$file" == *.asc ]]; then
              echo "Signing file: $file"
              gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --detach-sign --armor -o "$file.asc" "$file"
              gpg --verify "$file.asc" "$file"
            fi
          done

      - name: GPG - Clean up GNUPGHOME
        if: env.GPG_PUBLIC_KEY != ''
        run: rm -rf $GNUPGHOME

      - name: GPG - Export public key from secrets and save to output
        if: env.GPG_PUBLIC_KEY != ''
        run: |
          mkdir -p output
          echo "$GPG_PUBLIC_KEY" > output/canscan-public-key.asc

      - name: Create Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          name: CanScan release v${{ env.POM_VERSION }}
          tag: v${{ env.POM_VERSION }}
          body: |
            ## üì≤ CanScan v${{ env.POM_VERSION }}

            ### üíª Windows (64-bit Installer)

            Lien de l'installateur Windows x64 :

            &nbsp;&nbsp;&nbsp;&nbsp;[![Windows EXE](https://img.shields.io/badge/Windows_EXE-CanScan--${{ env.POM_VERSION }}--x64.exe-brightgreen.svg)](https://github.com/${{ github.repository }}/releases/download/v${{ env.POM_VERSION }}/CanScan-${{ env.POM_VERSION }}-x64.exe)

            ### üêß Linux (AppImage)

            Lien de l'AppImage (compatible avec la plupart des distributions Linux) :

            &nbsp;&nbsp;&nbsp;&nbsp;[![Linux AppImage](https://img.shields.io/badge/Linux_AppImage-CanScan--${{ env.POM_VERSION }}--x86__64.AppImage-blue.svg)](https://github.com/${{ github.repository }}/releases/download/v${{ env.POM_VERSION }}/CanScan-${{ env.POM_VERSION }}-x86_64.AppImage)

            ---
            ## V√©rification de l'int√©grit√© du fichier avec GPG

            **Pour garantir l'int√©grit√© des fichiers t√©l√©charg√©s, v√©rifiez leur signature √† l'aide de la cl√© publique GPG correspondante**

            Lien vers la cl√© publique GPG :

            &nbsp;&nbsp;&nbsp;&nbsp;[![Public GPG (GNU Privacy Guard)](https://img.shields.io/badge/Public_GPG-canscan--public--key.asc-brightgreen.svg)](https://github.com/${{ github.repository }}/releases/download/v${{ env.POM_VERSION }}/canscan-public-key.asc)

            ### Signatures et Empreintes

            | Fichier | Signature (.asc) | Empreinte (hash_*.txt) |
            | :--- | :--- | :--- |
            | Windows EXE | disponible | hash_windows.txt |
            | Linux AppImage | disponible | hash_ubuntu.txt |

          artifacts: 'output/*'

      - name: Create Tag
        run: git tag v${{ env.POM_VERSION }}

      - name: Push Tag
        run: git push --tags

      - name: Delete all artifacts and output folder after publishing
        uses: geekyeggo/delete-artifact@f275313e70c08f6120db482d7a6b98377786765b
        with:
          name: |
            output-folder-*

      - name: Remove output directory
        run: rm -rf output
